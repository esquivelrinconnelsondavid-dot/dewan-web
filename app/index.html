<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#05080e">
<title>DEWAN Admin</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¢</text></svg>">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#05080e; }
#root { min-height:100vh; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

const API = "https://restaurante1-n8n.bqspdc.easypanel.host/webhook/admin-api";
const REFRESH_INTERVAL = 15000;
const ADMIN_SESSION_KEY = "dewan_admin_user";

const post = async (body) => {
  try {
    const r = await fetch(API, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    return await r.json();
    const text = await r.text();
    try {
      return JSON.parse(text);
    } catch {
      if (!r.ok) return { ok: false, error: `Error del servidor (${r.status})` };
      return { ok: false, error: "Respuesta inv√°lida del servidor" };
    }
  } catch { return { ok: false, error: "Error de conexi√≥n" }; }
};

// ============================================================
// STYLES
// ============================================================
const CSS = `
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap');
:root {
  --bg: #05080e; --bg2: #0b1120; --bg3: #111827; --bg4: #1e293b;
  --accent: #10b981; --accent2: #059669; --accent-soft: rgba(16,185,129,0.08);
  --warn: #f59e0b; --danger: #ef4444; --info: #3b82f6; --purple: #8b5cf6;
  --text: #f1f5f9; --text2: #94a3b8; --text3: #64748b;
  --radius: 14px; --radius-sm: 10px;
  --font: 'DM Sans', sans-serif; --mono: 'JetBrains Mono', monospace;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font); background:var(--bg); color:var(--text); min-height:100vh; }
.admin-app { max-width:1400px; margin:0 auto; padding:16px; }

/* LOGIN */
.login-wrap { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
.login-box { background:var(--bg2); border:1px solid rgba(255,255,255,0.06); border-radius:20px; padding:48px 40px; width:100%; max-width:420px; box-shadow:var(--shadow); }
.login-logo { font-size:42px; text-align:center; margin-bottom:8px; }
@@ -442,66 +449,66 @@ function ComisionesTab({ data }) {
                {entregados.map(p => (
                  <tr key={p.id}>
                    <td>#{p.id}</td>
                    <td>{p.cliente}</td>
                    <td>{p.motorizado}</td>
                    <td className="money">${p.precio.toFixed(2)}</td>
                    <td className="money money-red">${(p.comision || p.precio * 0.3).toFixed(2)}</td>
                    <td className="money money-green">${(p.precio - (p.comision || p.precio * 0.3)).toFixed(2)}</td>
                    <td style={{ fontSize: 12, color: "var(--text3)" }}>{p.fecha_entrega ? new Date(p.fecha_entrega).toLocaleString("es-EC") : p.fecha ? new Date(p.fecha).toLocaleString("es-EC") : "-"}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </>
  );
}

// ============================================================
// MAIN APP
// ============================================================
function App() {
  const [admin, setAdmin] = useState(() => {
    try { return JSON.parse(null); } catch { return null; }
    try { return JSON.parse(localStorage.getItem(ADMIN_SESSION_KEY)); } catch { return null; }
  });
  const [tab, setTab] = useState("dashboard");
  const [data, setData] = useState(null);
  const [lastUpdate, setLastUpdate] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleLogin = (info) => {
    setAdmin(info);
    // session saved
    localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify(info));
  };

  const handleLogout = () => {
    setAdmin(null);
    setData(null);
    // session cleared
    localStorage.removeItem(ADMIN_SESSION_KEY);
  };

  const fetchData = useCallback(async () => {
    setLoading(true);
    const res = await post({ action: "dashboard" });
    if (res.ok) { setData(res); setLastUpdate(new Date()); }
    setLoading(false);
  }, []);

  useEffect(() => {
    if (!admin) return;
    fetchData();
    const interval = setInterval(fetchData, REFRESH_INTERVAL);
    return () => clearInterval(interval);
  }, [admin, fetchData]);

  if (!admin) return (<><style>{CSS}</style><LoginScreen onLogin={handleLogin} /></>);

  return (
    <>
      <style>{CSS}</style>
      <div className="admin-app">
        <div className="admin-header">
          <div className="admin-brand">
            <div className="admin-brand-icon">üè¢</div>
app/index.html
app/index.html
+20
-4

@@ -23,65 +23,69 @@ const { useState, useEffect, useRef, useCallback, useMemo } = React;
const API_BASE = "https://restaurante1-n8n.bqspdc.easypanel.host/webhook";
const API = {
  login: `${API_BASE}/moto-login`,
  pedidos: `${API_BASE}/pedidos-motorizado`,
  aceptar: `${API_BASE}/pedido-aceptado`,
  rechazar: `${API_BASE}/pedido-rechazado`,
  enCamino: `${API_BASE}/motorizado-en-camino`,
  llego: `${API_BASE}/motorizado-llego`,
  entregado: `${API_BASE}/motorizado-entregado`,
  enviarMensaje: `${API_BASE}/enviar-mensaje-cliente`,
  obtenerMensajes: `${API_BASE}/obtener-mensajes`,
  enviarFoto: `${API_BASE}/enviar-foto-cliente`,
  calcularPrecio: `${API_BASE}/calcular-precio`,
  ranking: `${API_BASE}/ranking-motorizados`,
  pushSubscribe: `${API_BASE}/push-subscribe`,
  pushNotify: `${API_BASE}/push-notify`,
};

const TOKEN_KEY = "dewan_moto_token";
const USER_KEY = "dewan_moto_user";
function saveSession(user) { const token = btoa(JSON.stringify({ ...user, ts: Date.now() })); localStorage.setItem(TOKEN_KEY, token); localStorage.setItem(USER_KEY, JSON.stringify(user)); }
function getSession() { try { const token = localStorage.getItem(TOKEN_KEY); if (!token) return null; const data = JSON.parse(atob(token)); if (Date.now() - data.ts > 86400000) { clearSession(); return null; } return JSON.parse(localStorage.getItem(USER_KEY)); } catch { clearSession(); return null; } }
function clearSession() { localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(USER_KEY); }
const VAPID_PUBLIC = 'BNoYANZydW3jshTIvAq4yiIL-Kp2FC4mSSMn0W3zn1OdVEYL1pIqNofOyoZG7RlOIz11WafNIUywd6rV1N-lOuA';
function urlBase64ToUint8Array(base64String) { const padding = '='.repeat((4 - base64String.length % 4) % 4); const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/'); const rawData = window.atob(base64); const outputArray = new Uint8Array(rawData.length); for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i); return outputArray; }
const pushRegistrationState = { motorizadoId: null, registered: false };
async function registerPushNotifications(motorizadoId) {
  try {
    if (pushRegistrationState.registered && pushRegistrationState.motorizadoId === motorizadoId) return true;
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) { console.log('Push no soportado'); return false; }
    const registration = await navigator.serviceWorker.register('/app/sw.js', { scope: '/app/' });
    await navigator.serviceWorker.ready;
    // Check for SW updates
    registration.update();
    await navigator.serviceWorker.ready;
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') { console.log('Permiso denegado'); return false; }
    let subscription = await registration.pushManager.getSubscription();
    if (!subscription) {
      subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC) });
    }
    await apiCall(API.pushSubscribe, { motorizado_id: motorizadoId, subscription: subscription.toJSON() });
    pushRegistrationState.registered = true;
    pushRegistrationState.motorizadoId = motorizadoId;
    console.log('Push registrado OK');
    return true;
  } catch (err) { console.error('Error push:', err); return false; }
}
async function apiCall(url, body = {}) { try { const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) }); const text = await res.text(); try { return JSON.parse(text); } catch { if (!res.ok) return { ok: false, error: `Error del servidor (${res.status})` }; return { ok: false, error: "Respuesta inv√°lida del servidor" }; } } catch (err) { console.error("API Error:", err); return { ok: false, error: "Sin conexi√≥n al servidor" }; } }
function cleanStr(val) { if (typeof val === "string") return val.replace(/^=/, "").trim(); return val; }

const NotificationManager = {
  _audioCtx: null,
  getAudioCtx() { if (!this._audioCtx) this._audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return this._audioCtx; },
  playNewOrderSound() { try { const ctx = this.getAudioCtx(); [0, 0.15, 0.3].forEach((delay, i) => { const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); osc.type = "sine"; osc.frequency.value = [523, 659, 784][i]; gain.gain.setValueAtTime(0.3, ctx.currentTime + delay); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.4); osc.start(ctx.currentTime + delay); osc.stop(ctx.currentTime + delay + 0.4); }); } catch (e) {} },
  playActionSound() { try { const ctx = this.getAudioCtx(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); osc.type = "sine"; osc.frequency.value = 880; gain.gain.setValueAtTime(0.2, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2); osc.start(); osc.stop(ctx.currentTime + 0.2); } catch (e) {} },
  vibrate(pattern = [200, 100, 200]) { try { navigator?.vibrate?.(pattern); } catch (e) {} },
  notifyNewOrder() { this.playNewOrderSound(); this.vibrate([200, 100, 200, 100, 300]); }
};

const globalStyles = `
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap');
:root{--bg-primary:#06090f;--bg-secondary:#0c1018;--bg-card:#111620;--bg-card-hover:#161d2c;--bg-elevated:#1a2130;--bg-input:#0a0f18;--accent:#22d3a7;--accent-dim:#1aab87;--accent-soft:rgba(34,211,167,0.08);--accent-glow:rgba(34,211,167,0.15);--accent-glow-strong:rgba(34,211,167,0.35);--danger:#f43f5e;--danger-soft:rgba(244,63,94,0.1);--warning:#f59e0b;--warning-soft:rgba(245,158,11,0.1);--info:#3b82f6;--info-soft:rgba(59,130,246,0.1);--success:#22d3a7;--purple:#a78bfa;--purple-soft:rgba(167,139,250,0.1);--text-primary:#f0f4f8;--text-secondary:#8b9bb4;--text-muted:#556077;--border:rgba(255,255,255,0.06);--border-light:rgba(255,255,255,0.1);--radius:16px;--radius-sm:12px;--radius-xs:8px;--shadow:0 4px 30px rgba(0,0,0,0.4);--shadow-lg:0 20px 60px rgba(0,0,0,0.5);--transition:all 0.25s cubic-bezier(0.4,0,0.2,1);--font:'Outfit',sans-serif;--font-mono:'JetBrains Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font);background:var(--bg-primary);color:var(--text-primary);-webkit-font-smoothing:antialiased;overflow-x:hidden}
.app-container{max-width:520px;margin:0 auto;min-height:100vh;position:relative;background:var(--bg-primary)}
@keyframes spin{to{transform:rotate(360deg)}}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}@keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}@keyframes slideDown{from{opacity:0;transform:translateY(-16px)}to{opacity:1;transform:translateY(0)}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}@keyframes glow{0%,100%{box-shadow:0 0 8px var(--accent-glow)}50%{box-shadow:0 0 24px var(--accent-glow-strong)}}@keyframes scaleIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}@keyframes newPedido{0%{opacity:0;transform:translateX(-20px) scale(0.95);border-color:var(--accent);box-shadow:0 0 30px var(--accent-glow-strong)}100%{opacity:1;transform:translateX(0) scale(1)}}
.fade-in{animation:fadeIn .4s ease-out}.slide-up{animation:slideUp .5s ease-out}.scale-in{animation:scaleIn .3s ease-out}
.spinner{width:24px;height:24px;border:2.5px solid var(--border-light);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}.spinner-sm{width:16px;height:16px;border-width:2px}
.login-screen{min-height:100vh;display:flex;flex-direction:column;justify-content:center;padding:32px 28px;background:radial-gradient(ellipse at 50% 0%,rgba(34,211,167,0.06) 0%,transparent 60%),var(--bg-primary)}
@@ -131,51 +135,51 @@ const I = {
  refresh: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
  back: <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
  map: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
  nav: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
  history: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
  pkg: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
  alert: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  clock: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  external: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
};

function ToastContainer({ toasts }) {
  return (<div className="toast-container">{toasts.map((t) => (<div key={t.id} className={`toast toast-${t.type}`}>{t.type === "success" && I.check}{t.type === "error" && I.alert}{t.type === "info" && I.clock}{t.type === "new" && "\u{1F514}"}<span>{t.message}</span></div>))}</div>);
}

function LoginScreen({ onLogin, toast }) {
  const [telefono, setTelefono] = useState("");
  const [pin, setPin] = useState("");
  const [loading, setLoading] = useState(false);
  const handleLogin = async (e) => {
    e.preventDefault();
    if (!telefono || !pin) { toast("Ingresa tel√©fono y PIN", "error"); return; }
    setLoading(true);
    try {
      const res = await apiCall(API.login, { telefono, pin });
      if (res.ok) { const user = { motorizado_id: cleanStr(String(res.motorizado_id)), nombre: cleanStr(res.nombre), telefono }; saveSession(user); onLogin(user); toast(`¬°Bienvenido, ${user.nombre}!`, "success"); registerPushNotifications(user.motorizado_id).then(ok => { if(ok) toast("üîî Notificaciones activadas", "info"); }); }
      if (res.ok) { const user = { motorizado_id: cleanStr(String(res.motorizado_id)), nombre: cleanStr(res.nombre), telefono }; saveSession(user); onLogin(user); toast(`¬°Bienvenido, ${user.nombre}!`, "success"); }
      else { toast(res.error || "Credenciales incorrectas", "error"); }
    } catch { toast("Error de conexi√≥n", "error"); }
    setLoading(false);
  };
  return (
    <div className="login-screen fade-in">
      <div className="login-logo"><div className="login-logo-icon">üèçÔ∏è</div><h1>DEWAN</h1><p>App Motorizado</p></div>
      <form className="login-form" onSubmit={handleLogin}>
        <div className="input-group"><label>Tel√©fono</label><input type="tel" placeholder="0999999999" value={telefono} onChange={(e) => setTelefono(e.target.value)} autoComplete="tel" /></div>
        <div className="input-group"><label>PIN de acceso</label><input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={pin} onChange={(e) => setPin(e.target.value)} maxLength={6} inputMode="numeric" /></div>
        <button type="submit" className="btn btn-primary btn-full" disabled={loading} style={{ marginTop: 8, height: 52 }}>{loading ? <div className="spinner spinner-sm" /> : "Iniciar Sesi√≥n"}</button>
      </form>
    </div>
  );
}

function MapModal({ direccion, lat, lng, direccionRetiro, onClose }) {
  const hasCoords = lat && lng && lat !== "" && lng !== "" && lat !== "undefined" && lng !== "undefined";
  const coordStr = hasCoords ? `${lat},${lng}` : null;
  const encoded = hasCoords ? coordStr : encodeURIComponent(direccion + ", Riobamba, Ecuador");
  const mapUrl = hasCoords
    ? `https://www.google.com/maps/embed/v1/place?key=AIzaSyBktkFnRg3Lp8h93MktPzQ2XtAcim7lAhs&q=${lat},${lng}&zoom=17`
    : `https://www.google.com/maps/embed/v1/place?key=AIzaSyBktkFnRg3Lp8h93MktPzQ2XtAcim7lAhs&q=${encodeURIComponent(direccion + ", Riobamba, Ecuador")}&zoom=16`;
  const navUrl = hasCoords
    ? `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`
@@ -187,55 +191,67 @@ function MapModal({ direccion, lat, lng, direccionRetiro, onClose }) {
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal map-modal" onClick={(e) => e.stopPropagation()}>
        <div className="map-modal-header">
          <div>
            <h3 style={{ fontSize: 15 }}>üìç Entrega: {direccion}</h3>
            {direccionRetiro && <div style={{ fontSize: 12, color: "var(--text-muted)", marginTop: 4 }}>üì¶ Retiro: {direccionRetiro}</div>}
            {hasCoords && <div style={{ fontSize: 10, color: "var(--accent)", marginTop: 2, fontFamily: "var(--font-mono)" }}>GPS: {Number(lat).toFixed(6)}, {Number(lng).toFixed(6)}</div>}
            {!hasCoords && <div style={{ fontSize: 10, color: "var(--warning)", marginTop: 2 }}>‚ö†Ô∏è Sin GPS, ubicaci√≥n aproximada por texto</div>}
          </div>
          <button className="btn btn-ghost btn-icon" onClick={onClose} style={{ width: 32, height: 32, flexShrink: 0 }}>{I.x}</button>
        </div>
        <iframe className="map-frame" src={mapUrl} allowFullScreen loading="lazy" referrerPolicy="no-referrer-when-downgrade" />
        <div className="map-modal-actions" style={{ flexDirection: "column", gap: 8 }}>
          <a href={navUrl} target="_blank" rel="noopener noreferrer" className="btn btn-primary btn-sm btn-full" style={{ textDecoration: "none" }}>{I.nav} Navegar con Google Maps</a>
          <a href={wazeUrl} target="_blank" rel="noopener noreferrer" className="btn btn-ghost btn-sm btn-full" style={{ textDecoration: "none", color: "var(--info)" }}>üó∫Ô∏è Abrir en Waze</a>
        </div>
      </div>
    </div>
  );
}

function PedidoCard({ pedido, user, onAction, toast, isNew }) {
  const [loadingAction, setLoadingAction] = useState(null);
  const [showMap, setShowMap] = useState(false);
  const [precioInfo, setPrecioInfo] = useState(null);
  const getGPS = () => new Promise((resolve) => { if (!navigator.geolocation) { resolve(null); return; } navigator.geolocation.getCurrentPosition((pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }), () => resolve(null), { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); });
  const getGPS = async () => {
    if (!navigator.geolocation) return null;
    const requestLocation = (opts) => new Promise((resolve) => {
      navigator.geolocation.getCurrentPosition((pos) => resolve({
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy || null
      }), () => resolve(null), opts);
    });
    const precise = await requestLocation({ enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    if (precise) return precise;
    return requestLocation({ enableHighAccuracy: false, timeout: 8000, maximumAge: 30000 });
  };
  const handleAction = async (action, extraBody = {}) => {
    setLoadingAction(action); NotificationManager.playActionSound();
    let url, body;
    if (action === "en_camino") { toast("üìç Obteniendo tu ubicaci√≥n...", "info"); const gps = await getGPS(); url = API.enCamino; body = { pedido_id: pedido.pedido_id, motorizado_lat: gps?.lat || "", motorizado_lng: gps?.lng || "", destino: pedido.direccion || "", destino_lat: pedido.ubicacion_lat || "", destino_lng: pedido.ubicacion_lng || "" }; }
    if (action === "en_camino") { toast("üìç Obteniendo tu ubicaci√≥n...", "info"); const gps = await getGPS(); if (!gps) toast("‚ö†Ô∏è No se pudo obtener GPS exacto. Se enviar√° con ubicaci√≥n aproximada.", "info"); url = API.enCamino; body = { pedido_id: pedido.pedido_id, motorizado_lat: gps?.lat || "", motorizado_lng: gps?.lng || "", motorizado_accuracy: gps?.accuracy || "", destino: pedido.direccion || "", destino_lat: pedido.ubicacion_lat || "", destino_lng: pedido.ubicacion_lng || "" }; }
    else { switch (action) { case "aceptar": url = API.aceptar; body = { pedido_id: pedido.pedido_id, motorizado_id: user.motorizado_id }; break; case "llego": url = API.llego; body = { pedido_id: pedido.pedido_id }; break; case "entregado": url = API.entregado; body = { pedido_id: pedido.pedido_id, motorizado_id: user.motorizado_id }; break; case "rechazar": url = API.rechazar; body = { pedido_id: pedido.pedido_id, motorizado_id: user.motorizado_id, ...extraBody }; break; default: return; } }
    const res = await apiCall(url, body);
    if (res.ok) {
      if (action === "en_camino" && res.precio_texto) { setPrecioInfo(res); toast(`Precio: ${res.precio_texto} (${res.distancia_texto})`, "success"); const hasCoords = pedido.ubicacion_lat && pedido.ubicacion_lng && pedido.ubicacion_lat !== ""; const navUrl = hasCoords ? `https://www.google.com/maps/dir/?api=1&destination=${pedido.ubicacion_lat},${pedido.ubicacion_lng}&travelmode=driving` : pedido.direccion ? `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(pedido.direccion + ", Riobamba, Ecuador")}&travelmode=driving` : null; if (navUrl) setTimeout(() => { if (confirm("¬øAbrir navegaci√≥n GPS?")) window.open(navUrl, '_blank'); }, 500); }
      else if (action === "entregado" && res.comision_dewan) { toast(`‚úÖ Entregado | Tu ganancia: $${res.ganancia_motorizado?.toFixed(2)} | Comisi√≥n DEWAN: $${res.comision_dewan?.toFixed(2)}`, "success"); }
      else if (action === "rechazar" && res.reasignado) { toast(`Rechazado ‚Üí Reasignado a ${res.nuevo_motorizado}`, "info"); }
      else { toast(res.mensaje || "Acci√≥n realizada", "success"); }
      onAction();
    } else { toast(res.error || "Error al procesar", "error"); }
    setLoadingAction(null);
  };
  const estadoLabel = { pendiente: "Pendiente", confirmado: "Nuevo", asignado: "üîî Nuevo", aceptado: "Aceptado", en_camino: "En Camino", entregado: "Entregado" };
  const typeConfig = { pedido_comida: { icon: "üçΩÔ∏è", label: "Pedido de comida", cls: "comida" }, encomienda: { icon: "üì¶", label: "Encomienda", cls: "encomienda" }, compras_supermercado: { icon: "üõí", label: "Compras", cls: "compras" }, compras: { icon: "üõí", label: "Compras", cls: "compras" }, pagos: { icon: "üí≥", label: "Pago / Tr√°mite", cls: "pagos" }, motorizado: { icon: "üèçÔ∏è", label: "Motorizado", cls: "motorizado" } };
  const tc = typeConfig[pedido.intencion] || { icon: "üìã", label: "Servicio", cls: "motorizado" };
  const hasDir = (pedido.direccion && pedido.direccion !== "Sin direcci√≥n" && pedido.direccion !== "null, null" && pedido.direccion !== "N/A" && pedido.direccion.trim() !== "" && pedido.direccion !== ", ") || (pedido.ubicacion_lat && pedido.ubicacion_lng && pedido.ubicacion_lat !== "" && pedido.ubicacion_lng !== "");
  return (
    <>
      <div className={`pedido-card ${isNew ? "new-pedido" : ""}`}>
        <div className="pedido-card-top">
          <div className="pedido-top-left"><div className={`pedido-type-icon pedido-type-${tc.cls}`}>{tc.icon}</div><div><div className="pedido-id">#{pedido.pedido_id}</div><div className="pedido-type-label">{tc.label}</div></div></div>
          <span className={`pedido-badge badge-${pedido.estado}`}>{estadoLabel[pedido.estado] || pedido.estado}</span>
        </div>
        <div className="pedido-card-body">
          <div className="pedido-row"><span className="pedido-row-icon">üë§</span><span><strong>{pedido.cliente}</strong> {pedido.telefono && <span style={{ color: "var(--text-muted)", fontSize: 12 }}>{pedido.telefono}</span>}</span></div>
          {pedido.direccion_retiro && <div className="pedido-row"><span className="pedido-row-icon" style={{ color: "var(--info)" }}>üìç</span><span><strong>Retiro:</strong> {pedido.direccion_retiro}</span></div>}
@@ -414,39 +430,39 @@ function Dashboard({ user, onLogout, toast }) {
  const pendientes = pedidos.filter((p) => p.estado === "pendiente" || p.estado === "confirmado" || p.estado === "asignado").length;
  const enProceso = pedidos.filter((p) => p.estado === "aceptado" || p.estado === "en_camino").length;
  const listaPedidos = tab === "activos" ? pedidosActivos : pedidosHistorial;
  return (
    <div className="app-container">
      <div className="header"><div className="header-left"><div className="header-avatar">üèçÔ∏è</div><div><div className="header-title">{user.nombre}</div><div className="header-subtitle"><span className="status-dot" /> EN L√çNEA</div></div></div><div className="header-right"><button className="btn btn-ghost btn-icon" onClick={handleRefresh} style={{ animation: refreshing ? "spin .6s linear infinite" : "none" }}>{I.refresh}</button><button className="btn btn-ghost btn-icon" onClick={() => { clearSession(); onLogout(); }} style={{ color: "var(--danger)" }}>{I.logout}</button></div></div>
      <div className="stats-row"><div className="stat-card"><div className="stat-number" style={{ color: "var(--accent)" }}>{pedidosActivos.length}</div><div className="stat-label">Activos</div></div><div className="stat-card"><div className="stat-number" style={{ color: "var(--warning)" }}>{pendientes}</div><div className="stat-label">Pendientes</div></div><div className="stat-card"><div className="stat-number" style={{ color: "var(--info)" }}>{enProceso}</div><div className="stat-label">En Proceso</div></div></div>
      <div className="tabs">
        <button className={`tab ${tab === "activos" ? "active" : ""}`} onClick={() => setTab("activos")}>{I.pkg} Activos {pedidosActivos.length > 0 && <span className="tab-badge">{pedidosActivos.length}</span>}</button>
        <button className={`tab ${tab === "historial" ? "active" : ""}`} onClick={() => setTab("historial")}>{I.history} Historial {pedidosHistorial.length > 0 && <span className="tab-badge" style={{ background: "var(--text-muted)", color: "var(--bg-primary)" }}>{pedidosHistorial.length}</span>}</button>
        <button className="tab" onClick={() => setShowRanking(true)} style={{ color: "#fbbf24" }}>üèÜ Ranking</button>
      </div>
      {tab === "historial" && pedidosHistorial.length > 0 && <HistoryStats pedidos={pedidos} />}
      {loading ? <div className="loading-overlay"><div className="spinner" /></div> : listaPedidos.length === 0 ? (
        <div className="empty-state fade-in"><div className="empty-icon">{tab === "activos" ? "üì¶" : "üìä"}</div><div className="empty-title">{tab === "activos" ? "Sin pedidos activos" : "Sin entregas a√∫n"}</div><div className="empty-text">{tab === "activos" ? "Los nuevos pedidos aparecer√°n aqu√≠ autom√°ticamente" : "Las entregas completadas se mostrar√°n aqu√≠"}</div></div>
      ) : <div className="pedido-list">{listaPedidos.map((p) => <PedidoCard key={p.pedido_id} pedido={p} user={user} onAction={handleAction} toast={toast} isNew={newPedidoIds.has(p.pedido_id)} />)}</div>}
      {rejectPedido && <RejectModal pedido={rejectPedido} user={user} onClose={() => setRejectPedido(null)} onDone={() => { setRejectPedido(null); cargarPedidos(false); }} toast={toast} />}
    </div>
  );
}

function App() {
  const [user, setUser] = useState(() => getSession());
  const [toasts, setToasts] = useState([]);
  const addToast = useCallback((message, type = "info") => { const id = Date.now(); setToasts((prev) => [...prev, { id, message, type }]); setTimeout(() => setToasts((prev) => prev.filter((t) => t.id !== id)), 4000); }, []);
  useEffect(() => { if (user?.motorizado_id) { registerPushNotifications(user.motorizado_id); } }, [user]);
  useEffect(() => { if (user?.motorizado_id) { registerPushNotifications(user.motorizado_id).then((ok) => { if (ok) addToast("üîî Notificaciones activadas", "info"); }); } }, [user, addToast]);
  return (
    <>
      <style>{globalStyles}</style>
      <ToastContainer toasts={toasts} />
      {user ? <Dashboard user={user} onLogout={() => setUser(null)} toast={addToast} /> : <LoginScreen onLogin={setUser} toast={addToast} />}
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
